<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Get GeoJSON</title>
    <meta http-equiv="cleartype" content="on">
    <link rel="stylesheet" href="//scraperwiki.com/vendor/style/bootstrap.min.css">
    <link rel="stylesheet" href="//scraperwiki.com/style/scraperwiki.css">
    <link rel="stylesheet" href="style.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
    <script src="//scraperwiki.com/vendor/js/bootstrap.min.js"></script>
    <script src="//scraperwiki.com/js/scraperwiki.js"></script>
    <script src="input_box.js"></script>
    <script>
      function saveSettings() {
        // Save all elements that have class "sw-persist".
        // :todo(drj): doesn't work for type="checkbox"; fix that.
        var toSave = {}
        $('.sw-persist').each(function(i, element) {
          var $element = $(element)
          toSave[element.id] = $element.val()
        });
        var saveString = JSON.stringify(toSave, null, 4)
        var escapedString = scraperwiki.shellEscape(saveString)
        scraperwiki.exec(
          "printf > allSettings.json '%s' " + escapedString
          , function(){})
      }
      function loadSettings(callback) {
        scraperwiki.tool.exec('touch allSettings.json; cat allSettings.json',
          function(content) {
            window.allSettings = {}
            if(content) {
              try {
                window.allSettings = JSON.parse(content)
              } catch(e) {
                smart_alert("Failed to parse settings file",
                  String(e), "\n\n" + content)
              }
            }
            callback()
          })
      }
      function populateForm() {
        $('.sw-persist').each(function(i, element) {
          var $element = $(element)
          $element.val(window.allSettings[element.id])
        });
      }

      $(function() {
          loadSettings(populateForm)

          // Setup the "submit" button.
          var execSuccess = function(execOutput) {
            var datasetUrl = "/dataset/" + scraperwiki.box
            scraperwiki.tool.redirect(datasetUrl)
          }
          $('#source-go').on('click', function() {
            $(this).addClass('loading').html('Fetchingâ€¦')
            var q = $('#source-url').val()
            scraperwiki.exec("tool/geojson.py " + scraperwiki.shellEscape(q),
              execSuccess)
            scraperwiki.dataset.name("GeoJSON from " + name_from_url(q))
            saveSettings()
          })

          // various "stuff", mostly nicked from table-extract-tool
          stuff_init()
      })
    </script>
  </head>
  <body>
    <div id="settings">
      <p id="label"><label for="source-url">Get GeoJSON from URL:</label></p>
      <p id="inputs">
        <input type="text" name="source-url" size="80" id="source-url"
          class="sw-persist"
          placeholder="URL, eg: http://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_day.geojson">
        <button class="btn btn-primary pull-right" type="submit" id="source-go">Get Data</button>
      </p>
      <p id="message" class="muted">Try any GeoJSON URL
      or try <a id="show-examples">one of our examples</a>. <!--
      <label id="upload-a-file" for="file">upload a file from your
      computer</label> -->
      </p>
    </div>

    <div id="examples">
      <ul>
        <li><a href="https://raw.githubusercontent.com/peterdesmet/traffic-signs-hansbeke/master/data/traffic-signs-hansbeke.geojson">Little Dutch Traffic Signs</a></li>
        <li><a href="http://www.manchester.gov.uk/site/custom_scripts/getdirectorygeo.php?directory=42&category=">Northern Grit</a></li>
      </ul>
    </div>

<script>
$(function(){
  $('#q').on('keypress', function(e){
    if(e.which == 13) {
      $('#source-go').trigger('click')
    }
  })
})
</script>
  </body>
</html>
